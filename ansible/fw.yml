# vim:ft=yaml

- hosts: sa2
  gather_facts: False
  become: true

  pre_tasks:
    - name: Bootstrap
      include_tasks: subtasks/bootstrap.yml

  tasks:
    - name: add influxDB apt repo
      include_tasks: subtasks/influx_repo.yml

    - name: setup telegraf
      include_tasks: subtasks/telegraf_setup.yml

    - name: install packages
      apt:
        pkg:
          - ruby
          - rsyslog

    #arch wiki ftw https://wiki.archlinux.org/index.php/Network_bridge
    - name: Enable ip forwarding
      raw: sh -c "echo 1 > /proc/sys/net/ipv4/ip_forward"

    - name: make interfaces promisc
      raw: ip link set {{ item }} promisc on
      with_items:
        - enp0s9
        - enp0s10

    - name: create bridge
      raw: sh -c "ip link add name br0 type bridge | true"

    - name: set bridge up
      raw: ip link set br0 up

    - name: add interfaces to bridge
      raw: ip link set {{ item }} master br0
      with_items:
        - enp0s9
        - enp0s10

    - name: Load br_netfilter kernel module
      modprobe:
        name: br_netfilter
        state: present


    - name: Install pip3
      apt:
        name: python3-pip
        state: present

    - name: Install pip2
      apt:
        name: python-pip
        state: present

    - name: install pip packages
      pip:
        name:
          - flask
          - requests
          - netifaces
          - PyJWT

- name: Setup wrapper
  hosts: sa2
  gather_facts: False
  become: false

  tasks:
    - name: clone repo
      git:
        repo: git@gitlab2.informatik.uni-wuerzburg.de:descartes/nfv-security/SecurityApplianceWrapper.git
        dest: SecurityApplianceWrapper
        accept_hostkey: yes

    - name: copy config
      copy:
        src: firewallwrapper.ini
        dest: wrapper.ini
      # Start wrapper

- name: Setup Firewall
  hosts: sa2
  gather_facts: False
  become: false

  tasks:
    - name: clone repo
      git:
        repo: git@gitlab2.informatik.uni-wuerzburg.de:descartes/nfv-security/FireGuardian.git
        dest: FireGuardian
        accept_hostkey: yes

    - name: install filewatcher
      gem:
        name: filewatcher
        state: present

    - name: install concurrent-ruby
      gem:
        name: concurrent-ruby
        state: present

    # sudo ruby firewall.rb

# todo in roles just for testing in fw
- name: Setup l7sdntest
  become: true
  hosts: sa2

  tasks:
    - name: Update Apt Cache
      become: true
      apt:
        update_cache: yes

    - name: Install OpenJDK Java Java 11
      become: yes
      apt:
        name: openjdk-11-jdk
        state: present

    - name: create directory l7sdntest jar
      file:
        path: /home/vagrant/l7sdntest
        state: directory

    - name: copy l7sdntest.jar
      copy:
        src: subtasks/l7sdntest/l7sdntest.jar
        dest: /home/vagrant/l7sdntest
        mode: '0777'


# todo on seperate server , just for testing purposes
- name: Setup MySQL for ComApp
  become: true
  hosts: sa2

  tasks:
    - name: Update Apt Cache
      become: true
      apt:
        update_cache: yes

    - name: bugfix
      become: yes
      apt:
        name: libmysqlclient-dev
        state: present

    - name: install mysql
      become: yes
      apt:
        name: mysql-server
        state: present

    - name: install MySQL-python for modifications
      pip:
        name:
          - MySQL-python

    - name: Create database user with name 'l7sdntestuser' and password 'root' with all database privileges
      mysql_user:
        name: l7sdntestuser
        password: root
        priv: '*.*:ALL' #all priviliges to the l7sdntestuser (issues with l7sdntest)
        state: present

    - name: Create a new database with name 'l7sdntest'
      mysql_db:
        name: l7sdntest
        state: present

    - name: create directory mysqlFiles
      file:
        path: /home/vagrant/mysqlFiles
        state: directory

    - name: copy mysql configuration
      copy:
        src: subtasks/mysql/controller_db_dumb.sql
        dest: /home/vagrant/mysqlFiles
        mode: '0777'

    - name: Create Tables
      mysql_db:
        name: l7sdntest
        state: import
        target: /home/vagrant/mysqlFiles/controller_db_dumb.sql

    - name: Update, Upgrade, Reboot FW
      include_tasks: subtasks/update.yml

# todo on seperate comapp server
- name: Setup Ryu SDN Controllers
  become: true
  hosts: sa2
  gather_facts: false
  tasks:

    - name: install ryu
      pip:
        name:
          - ryu
          - flask
          - PyJWT
          - numpy

    - name: Create Directory ryu
      file:
        path: /home/vagrant/ryu
        state: directory

    - name: install sqlite
      become: yes
      apt:
        name: sqlite3
        state: present

    - name: Copy all SDN Controller Files Ryu
      copy: src=subtasks/l7sdntest/comapp/{{ item }} dest=/home/vagrant/ryu
      with_items:
        - l7sdntest_easy_lb.py
        - l7sdntest_easy_nothing.py
        - l7sdntest_lb_mysql.py
        - master_blacklisting.py
        - master_whitelisting.py
        - PiotrNo3.py


