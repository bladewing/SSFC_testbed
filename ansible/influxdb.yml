# vim:ft=yaml

- hosts: all
  become: true

  tasks:
    - name: Import InfluxDB GPG signing key
      apt_key: url=https://repos.influxdata.com/influxdb.key state=present

    - name: Add InfluxDB repository
      apt_repository: repo='deb https://repos.influxdata.com/ubuntu bionic stable' state=present

    - name: Install InfluxDB packages
      apt: name=influxdb state=present

    - name: Modify InfluxDB hostname
      replace:
        path: /etc/influxdb/influxdb.conf
        regexp: 'hostname = "localhost"'
        replace: 'hostname = "{{ ansible_hostname }}"'
        backup: yes
      register: influx_conf

    - name: Restart if reconfigured
      service: name=influxdb state=restarted
      when: influx_conf.changed

    - name: Start the InfluxDB service
      service: name=influxdb state=started
      when: not influx_conf.changed
